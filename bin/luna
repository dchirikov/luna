#!/usr/bin/env python
'''
Written by Dmitry Chirikov <dmitry@chirikov.ru>
This file is part of Luna, cluster provisioning tool
https://github.com/dchirikov/luna

This file is part of Luna.

Luna is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Luna is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with Luna.  If not, see <http://www.gnu.org/licenses/>.

'''

import os
import sys
import luna
import tempfile
import subprocess
import logging
import hostlist
import time

from signal import signal, SIGPIPE, SIG_DFL, SIGHUP
from argparse import ArgumentParser

from luna import utils


# Restore SIGPIPE's default unix behaviour
# (newbebweb.blogspot.nl/2012/02/python-head-ioerror-errno-32-broken.html)
# (docs.python.org/library/signal.html)

signal(SIGPIPE, SIG_DFL)

logging.basicConfig(level=logging.INFO)
log = logging.getLogger('luna')
def_format = '%20s%40s\n'


def print_table(header, content):
    for key in content:
        if key[1] is None:
            key[1] = '-'

    out = {'header': header , 'content': content}
    (lengths, header_array, content_array) = utils.helpers.format_output(out)

    spaces = 4
    fmt_str = [ "| %-" + str(spaces + lengths[i]) + "s" for i in range(len(lengths))]
    out_len = sum(lengths) + (spaces + 2) * len(lengths) + 1
    format_string = "".join(fmt_str)+"|"

    separator = "+" + "+".join(["-" * (i + spaces + 1) for i in lengths]) + "+"

    print(separator)

    for i in range(len(header_array)):
        print(format_string % tuple(header_array[i]))

    print(separator)

    for i in range(len(content_array)):
        print(format_string % tuple(content_array[i]))

    print(separator)

def check_active_node():
    if not luna.Cluster().is_active():
        log.error("Inactive HA node.")
        exit(1)

#################### Cluster

def cluster_init(nodeprefix, nodedigits, path, user):
    cluster = luna.Cluster(create=True, nodeprefix = nodeprefix, nodedigits = nodedigits, path = path, user = user)

def cluster_delete():
    cluster = luna.Cluster()
    cluster.delete()

def cluster_change(**args):
    cluster = luna.Cluster()
    for key in args:
        if args[key] == None:
            continue
        cluster.set(key, args[key])

def cluster_show(raw, out_format = def_format):
    cluster = luna.luna.Cluster()
    if raw:
        print(cluster.nice_json)
        return None
    out_json = cluster.show()
    out_str = []
    name = out_json.pop('name')
    if bool(cluster.get('dhcp_net')):
        dhcp_net = out_json.pop('dhcp_net')
        dhcp_range_start = out_json.pop('dhcp_range_start')
        dhcp_range_end = out_json.pop('dhcp_range_end')
        out_json['dhcp_net'] = '[' + cluster.get('dhcp_net') + ']'
        out_json['dhcp_range_start'] = cluster.get('dhcp_range_start')
        out_json['dhcp_range_end'] = cluster.get('dhcp_range_end')
    for key in sorted(out_json):
        out_str.append([key, out_json[key]])
    print_table(['Parameter', 'Value'], out_str)

def cluster_sync():
    cluster = luna.Cluster()
    if not cluster.is_ha():
        return True
    path = cluster.get("path")
    ips = cluster.get_cluster_ips()
    for ip in ips[1:]:
        print("%s:%s => %s:%s" % (ips[0], path, ip, path))
        utils.helpers.rsync_data(ip, path)
    print("Done. Luna daemons probably need to be restarted manually.")

def cluster_makedns():
    cluster = luna.Cluster()
    res = cluster.makedns()
    if not res:
        return False
    print("Reloading local named.")
    proc = subprocess.Popen(['/usr/bin/systemctl',
        'reload', "named"], stdout=subprocess.PIPE, close_fds=True)
    streamdata = proc.communicate()[0]
    if proc.returncode:
        print("Unable to reload named. Exit code is non-zero.")
        sys.exit(1)
    print("Success.")
    if not cluster.is_ha():
        return True
    files = []
    includefile = cluster.get('named_include_file')
    zonedir = cluster.get('named_zone_dir')
    files.extend([includefile])
    files.extend([zonedir])
    ips = cluster.get_cluster_ips()
    for ip in ips[1:]:
        for path in files:
            print("%s:%s => %s:%s" % (ips[0], path, ip, path))
            utils.helpers.rsync_data(ip, path)
        print("Reloading remote namded on " + ip + ".")
        ssh_proc = subprocess.Popen(['/usr/bin/ssh',
            '-o', 'StrictHostKeyChecking=no',
            '-o', 'UserKnownHostsFile=/dev/null', ip,
            'systemctl', "reload", "named"], stdout=subprocess.PIPE, close_fds=True)
        streamdata = ssh_proc.communicate()[0]
        if ssh_proc.returncode:
            print("Unable to reload named on " + ip + ". Exit code is non-zero.")
            sys.exit(1)
        print("Success.")
    return True

def cluster_makedhcp(**args):
    cluster = luna.Cluster()
    res = cluster.makedhcp(args['network'], args['start_ip'], args['end_ip'], args['no_ha'])
    if not res:
        return False
    _run_command(['/usr/bin/systemctl', 'stop', "dhcpd"],
        "Stopping local dhcpd.",
        "Unable to stop named. Exit code is non-zero.")
    if cluster.is_ha():
        ips = cluster.get_cluster_ips()
        for ip in ips:
            _run_command(['/usr/bin/ssh',
                    '-o', 'StrictHostKeyChecking=no',
                    '-o', 'UserKnownHostsFile=/dev/null', ip,
                    'systemctl', "stop", "dhcpd"],
                "Stop dhcpd on " + ip + ".",
                "Unable to stop dhcpd.")
            _run_command(['/usr/bin/scp',
                    '-o', 'StrictHostKeyChecking=no',
                    '-o', 'UserKnownHostsFile=/dev/null',
                    '/etc/dhcp/dhcpd-secondary.conf',
                    ip + ":/etc/dhcp/dhcpd.conf"],
                "Copy dhcpd config file to " + ip + ".",
                "Unable to copy file.")
            _run_command(['/usr/bin/ssh',
                    '-o', 'StrictHostKeyChecking=no',
                    '-o', 'UserKnownHostsFile=/dev/null', ip,
                    'systemctl', "stop", "dhcpd"],
                "Stop dhcpd on " + ip + ".",
                "Unable to stop dhcpd.")
            _run_command(['/usr/bin/ssh',
                    '-o', 'StrictHostKeyChecking=no',
                    '-o', 'UserKnownHostsFile=/dev/null', ip,
                    'rm', "-rf", "/var/lib/dhcpd/dhcpd.*"],
                "Removing lease files on " + ip + ".",
                "Unable to remove.")
            _run_command(['/usr/bin/ssh',
                    '-o', 'StrictHostKeyChecking=no',
                    '-o', 'UserKnownHostsFile=/dev/null', ip,
                    'touch', "/var/lib/dhcpd/dhcpd.leases"],
                "Create lease file on " + ip + ".",
                "Unable to create.")
    print("Remove lease files")
    try:
        f = open('/var/lib/dhcpd/dhcpd.leases', 'w')
        f.close()
    except:
        pass
    try:
        os.remove('/var/lib/dhcpd/dhcpd.leases~')
    except:
        pass
    _run_command(['/usr/bin/systemctl', 'start', "dhcpd"],
        "Starting local dhcpd.",
        "Unable to start dhcpd. Exit code is non-zero.")
    time.sleep(3)
    if not cluster.is_ha() or args['no_ha']:
        return True
    for ip in ips:
        _run_command(['/usr/bin/ssh',
                '-o', 'StrictHostKeyChecking=no',
                '-o', 'UserKnownHostsFile=/dev/null', ip,
                'systemctl', "start", "dhcpd"],
            "Start dhcpd on " + ip + ".",
            "Unable to start dhcpd.")
    return True



def _run_command(cmd, descr, err):
    print(descr)
    ssh_proc = subprocess.Popen(cmd, stdout=subprocess.PIPE, close_fds=True)
    streamdata = ssh_proc.communicate()[0]
    if ssh_proc.returncode:
        print(err)
        sys.exit(1)

#################### OsImage

def osimage_list():
    lst = luna.list('osimage')
    header = ['Name', 'Path', 'Kernel version']
    content = []
    for elem in lst:
        osimage = luna.OsImage(elem)
        content.append([elem, osimage.get('path'), osimage.get('kernver')])
    print_table(header, content)

def osimage_show(out_format = def_format, **args):
    osimage = luna.OsImage(name = args['name'])
    if args['raw']:
        print(osimage.nice_json)
        return None
    if args['path']:
        print(osimage.get('path'))
        return None
    if args['grab_filesystems']:
        _safe_print(osimage.get('grab_filesystems'))
        return None
    if args['kernver']:
        for elem in osimage.list_kernels():
            if elem == osimage.get('kernver'):
                print(elem + ' <=')
                continue
            print(elem)
        return None
    if args['grab_exclude_list']:
        _safe_print(osimage.get('grab_exclude_list'))
        return None
    out_json = osimage.show()
    out_str = ''
    header = ['Parameter', 'Value']
    content = []
    name = out_json.pop('name')
    content.append(['name', name])
    for key in sorted(out_json):
        content.append([key, out_json[key]])
    print_table(header, content)

def osimage_listkerns(name):
    osimage = luna.OsImage(name = name)
    for elem in osimage.list_kernels():
        print(elem)

def osimage_add(**args):
    args['create'] = True
    osimage = luna.OsImage(**args)

def osimage_delete(name):
    osimage = luna.OsImage(name)
    osimage.delete()

def osimage_change(**args):
    osimage = luna.OsImage(args['name'])
    args.pop('name')
    if args['grab_exclude_list']:
        old_list = osimage.get('grab_exclude_list')
        new_list = _edit_script(old_list)
        osimage.set('grab_exclude_list', new_list)
        return None
    for key in args:
        if not args[key]:
            continue
        osimage.set(key, args[key])

def osimage_pack(**args):
    def pack_image(osimage):
        try:
            print('Creating tarball.')
            res = osimage.create_tarball()
            print('Done.')
        except:
            return None
        try:
            print('Creating torrent.')
            res = osimage.create_torrent()
            print('Done.')
        except:
            return None
        return True

    def pack_boot(osimage, copy):
        if not copy:
           print('Copying kernel & packing inirtd.')
           osimage.pack_boot()
        else:
            print('Copying kernel and initrd from image.')
            osimage.copy_boot()
        print('Done.')

    def update_ltorrent():
        try:
            pf = open(luna.Cluster().get('torrent_pidfile'), 'r')
            pid = int(pf.read().strip())
            pf.close()
        except IOError:
            pid = None
        if pid:
            try:
                os.kill(pid, SIGHUP)
            except OSError:
                print("No such process with pid %i. Is ltorrent running?" % pid)
        else:
            print("Ltorrent is not running")


    osimage = luna.OsImage(args['name'])
    if args['boot']:
        pack_boot(osimage, args['copy_boot'])
        update_ltorrent()
        return True
    if args['image']:
        pack_image(osimage)
        return True
    pack_image(osimage)
    pack_boot(osimage, args['copy_boot'])
    update_ltorrent()
    osimage_sync(args['name'])
    return True

def osimage_grab(**args):
    osimage = luna.OsImage(args['name'])
    res = osimage.grab_host(host = args['host'],
        dry_run = args['dry_run'],
        verbose = args['verbose'])
    return res

def osimage_sync(name):
    cluster = luna.Cluster()
    if not cluster.is_ha():
        return True
    lunapath = cluster.get("path")
    osimage = luna.OsImage(name)
    osimagepath = osimage.get("path")
    initrdfile = lunapath + "/boot/" + osimage.get("initrdfile")
    kernfile = lunapath + "/boot/" + osimage.get("kernfile")
    tarball = lunapath + "/torrents/" + osimage.get("tarball") + ".tgz"
    torrent = lunapath + "/torrents/" + osimage.get("torrent") + ".torrent"
    ips = cluster.get_cluster_ips()
    for ip in ips[1:]:
        for path in (osimagepath, initrdfile, kernfile, tarball, torrent):
            print("%s:%s => %s:%s" % (ips[0], path, ip, path))
            utils.helpers.rsync_data(ip, path)
        print("Reloading ltorrent on " + ip)
        ssh_proc = subprocess.Popen(['/usr/bin/ssh',
            '-o', 'StrictHostKeyChecking=no',
            '-o', 'UserKnownHostsFile=/dev/null', ip,
            '/usr/sbin/ltorrent', "reload"], stdout=subprocess.PIPE, close_fds=True)
        streamdata = ssh_proc.communicate()[0]
        if ssh_proc.returncode:
            print("Exit code is non-zero")
            sys.exit(1)
    print("Done.")
    return True

def osimage_clone(**args):
    osimage = luna.OsImage(args['name'])
    # check if osimage we need to create exists already
    lst = luna.list('osimage')
    if args['to'] in lst:
        sys.stderr.write("OsImage {} already exists.\n".format(args['to']) )
        sys.exit(1)
    osimagepath = osimage.get("path")
    targetpath = os.path.abspath(args['path'])
    if os.path.exists(targetpath):
        sys.stderr.write("Path {} already exists.\n".format(targetpath) )
        sys.exit(1)
    print("%s => %s" % (osimagepath, targetpath))
    utils.helpers.clone_dirs(osimagepath, targetpath)
    # create osimage
    newosimage = luna.OsImage(name = args['to'],
        create = True,
        path = targetpath,
        kernver = osimage.get('kernver'))
    # copy params
    for param in ['dracutmodules', 'kernmodules', 'kernopts', 'grab_filesystems', 'grab_exclude_list']:
        newosimage.set(param, osimage.get(param))
    return True

def osimage_rename(**args):
    osimage = luna.OsImage(args['name'])
    osimage.rename(args['newname'])


#################### BMCSetup

def bmcsetup_list():
    lst = luna.list('bmcsetup')
    header = ['Name', 'User', 'Password']
    content = []
    for elem in lst:
        bmcsetup = luna.BMCSetup(elem)
        content.append([elem, bmcsetup.get('user'), bmcsetup.get('password')])
    print_table(header, content)

def bmcsetup_show(name, raw, out_format = def_format):
    bmcsetup = luna.BMCSetup(name = name)
    if raw:
        print(bmcsetup.nice_json)
        return None
    out_json = bmcsetup.show()
    header = ['Parameter', 'Value']
    content = []
    name = out_json.pop('name')
    content.append(['name', name])
    for key in sorted(out_json):
        content.append([key, out_json[key]])
    print_table(header, content)

def bmcsetup_add(**args):
    args['create'] = True
    bmcsetup = luna.BMCSetup(**args)

def bmcsetup_change(**args):
    bmcsetup = luna.BMCSetup(args['name'])
    args.pop('name')
    for key in args:
        if not args[key]:
            continue
        bmcsetup.set(key, args[key])

def bmcsetup_delete(name):
    bmcsetup = luna.BMCSetup(name)
    bmcsetup.delete()

def bmcsetup_rename(**args):
    bmcsetup = luna.BMCSetup(args['name'])
    bmcsetup.rename(args['newname'])

#################### Network

def network_list():
    networks = luna.list('network')
    header = ['Name', 'Network']
    content = []
    for elem in networks:
        net = luna.Network(elem)
        content.append([elem, net.get('NETWORK') + "/" + str(net.get('PREFIX'))])
    print_table(header, content)

def network_show(name, raw, reservedips, out_format = '%20s%60s\n'):
    net = luna.Network(name = name)
    if raw:
        print(net.nice_json)
        return None
    if reservedips:
        nonfree = utils.freelist.get_nonfree(net['freelist'])
        ips = [utils.ip.reltoa(net['NETWORK'], elem) for elem in nonfree]
        print("\n".join(["%s" % i for i in ips ]))
        return None
    out_json = net.show()
    header = ['Parameter', 'Value']
    content = []
    content.append(['name', name])
    out_json.pop('freelist')
    out_json.pop('name')
    out_json['NETWORK'] = net.get('NETWORK')
    out_json['ns_ip'] = net.get('ns_ip')
    for key in sorted(out_json):
        content.append([key, out_json[key]])
    print_table(header, content)

def network_add(name, network, prefix, ns_hostname, ns_ip):
    net = luna.Network(name = name, create = True, NETWORK = network, PREFIX = prefix, ns_hostname = ns_hostname, ns_ip = ns_ip)

def network_change(name, network, prefix, reserve, release, ns_hostname, ns_ip):
    net = luna.Network(name = name)
    if bool(network):
        net.set('NETWORK', network)
    if bool(prefix):
        net.set('PREFIX', prefix)
    if bool(reserve):
        net.reserve_ip(reserve)
    if bool(release):
        net.release_ip(release)
    if bool(ns_hostname):
        net.set('ns_hostname', ns_hostname)
    if bool(ns_ip):
        net.set('ns_ip', ns_ip)
    return None

def network_delete(name):
    net = luna.Network(name)
    net.delete()

def network_rename(**args):
    net = luna.Network(args['name'])
    net.rename(args['newname'])

#################### Group

def group_list():
    groups = luna.list('group')
    header = ['Name', 'Osimage', 'Interfaces']
    content = []
    for elem in groups:
        group = luna.Group(elem)
        # dirty and ugly, but pyton-ish
        bmcnet = group.show_bmc_if(brief = True)
        interfaces = "BMC:" + str(bmcnet if bmcnet else None)
        for k in group.show()['interfaces'].keys():
            brief_if = group.show_if(k, brief = True)
            if bool(brief_if):
                interfaces += ", %s:%s" % (k, brief_if)
            else:
                interfaces += ", %s:%s" % (k, None)

        content.append([elem, group.show()['osimage'], interfaces])
    print_table(header, content)

def group_show(out_format = '%20s%60s\n', **args):
    group = luna.Group(name = args['name'])
    if args['raw']:
        print(group.nice_json)
        return None
    if bool(args['interface']):
        print(group.show_if(args['interface']))
        return None
    elif bool(args['bmcnetwork']):
        print(group.show_bmc_if())
        return None
    scr_type =''
    if bool(args['prescript']):
        scr_type = 'prescript'
    elif bool(args['partscript']):
        scr_type = 'partscript'
    elif bool(args['postscript']):
        scr_type = 'postscript'
    if scr_type:
        print(group.show()[scr_type])
        return None
    if bool(args['osimage']):
        print(group.show()['osimage'])
        return None
    if bool(args['bmcsetup']):
        print(group.show()['bmcsetup'])
        return None
    out_json = group.show()
    grpname = out_json.pop('name')
    bmcnet = group.show_bmc_if(brief = True)

    interfaces = "BMC:" + str(bmcnet if bmcnet else None) + ", "
    interfaces += ", ".join(["%s:%s" % (k, group.show_if(k, brief = True) if group.show_if(k) else None) for k in group.show()['interfaces'].keys()])
    out_json['interfaces'] = interfaces
    header = ['Parameter', 'Value']
    content = []
    content.append(['name', grpname])
    for key in sorted(out_json):
        content.append([key, out_json[key]])
    print_table(header, content)

def group_add(**args):
    args['create'] = True
    args['interfaces'] = args['interface']
    args.pop('interface')
#    try:
#        interface_list  = args.pop('interface')
#        args['interfaces'] = dict( i.split(':') for i in interface_list)
#    except:
#        log.error('Error parsing interface parameters.')
#        return None
    group = luna.Group(**args)

def group_change(**args):
    parm_sum = 0
    for elem in ['prescript', 'postscript', 'partscript', 'interface']:
        parm_sum += int(bool(args[elem]))
    if parm_sum > 1 and args['edit']:
        log.error('Only one element can be edited')
        return None
    #if args['interface'] == 'BMC':
    #    args['interface'] = None
    #    args['bmcnetwork'] = True
    group = luna.Group(args['name'])
    if bool(args['interface']):
        if bool(args['add']):
            group.add_interface(args['interface'])
        elif bool(args['delete']):
            group.del_interface(args['interface'])
        elif bool(args['setnet']):
            group.set_net_to_if(args['interface'], args['setnet'])
        elif bool(args['delnet']):
            group.del_net_from_if(args['interface'])
        elif args['edit']:
            group.set_if_params(args['interface'], _edit_script(group.get_if_params(args['interface'])))
        else:
            print(group.show_if(args['interface']))
    elif bool(args['bmcnetwork']):
        if bool(args['setnet']):
            group.set_bmcnetwork(args['setnet'])
        elif bool(args['delnet']):
            group.del_bmcnetwork()
        else:
            print(group.show_bmc_if())
    if type(args['boot_if']) == type(''):
        group.set('boot_if', args['boot_if'])
    if type(args['torrent_if']) == type(''):
        group.set('torrent_if', args['torrent_if'])
    if bool(args['osimage']):
        group.osimage(args['osimage'])
    if bool(args['bmcsetup']) or args['bmcsetup'] == '':
        group.bmcsetup(args['bmcsetup'])
    if bool(args['prescript']):
        scr_type = 'prescript'
    elif bool(args['partscript']):
        scr_type = 'partscript'
    elif bool(args['postscript']):
        scr_type = 'postscript'
    else:
        return None
    old_script = group.show()[scr_type]
    if not args['edit']:
        print(old_script)
        return None
    script = _edit_script(old_script)
    if not bool(script):
        script = ''
    group.set(scr_type, script)

def _edit_script(old_script):
    # old_script can be None
    if not bool(old_script):
        old_script = ''
    script = ''
    if not sys.stdin.isatty():
        for line in sys.stdin:
            script += line
    else:
        EDITOR = os.environ.get('EDITOR','vi')
        tmpfile = tempfile.NamedTemporaryFile(suffix=".tmp")
        tmpfile.write(old_script)
        tmpfile.flush()
        subprocess.call([EDITOR, '+":set syn=sh"', tmpfile.name])
        tmpfile.file.seek(0)
        for line in tmpfile.file.readlines():
            script += line
    return script

def group_delete(name):
    group = luna.Group(name)
    group.delete()

def group_rename(**args):
    grp = luna.Group(args['name'])
    grp.rename(args['newname'])

#################### Node

def node_list():
    nodes = luna.list('node')
    header = ['Name', 'Group', 'MAC', 'IPs']
    content = []
    for elem in nodes:
        ips = ''
        node = luna.Node(elem)
        out_json = node.show()
        interfaces = node.get('interfaces').keys()
        bmcip = node.get_ip(bmc=True)
        group = out_json['group']
        mac = node.get_mac()
        if_str = ''
        for interface in interfaces:
            ip = node.get_ip(interface)
            if_str += '%s:%s, ' % (interface, ip)
        if_str += '%s:%s' % ('BMC', bmcip)
        content.append([elem, group, mac, if_str])
    print_table(header, content)

def node_show(name, raw, out_format='%20s%60s\n'):
    for nodename in hostlist.expand_hostlist(name):
        node = luna.Node(name=nodename)
        if raw:
            print(node.nice_json)
            return None
        out_json = node.show()
        curent_node_name = out_json.pop('name')
        status = node.get_status()
        if status:
            out_json['status'] = "%s - %s" % (status['status'], status['time'])
        bmcip = node.get_ip(bmc=True)
        if_str = ''
        interfaces = node.get('interfaces').keys()
        for interface in interfaces:
            ip = node.get_ip(interface)
            if_str += '%s:%s, ' % (interface, ip)
        out_json['interfaces'] = if_str.rstrip(', ')
        out_json['bmcnetwork'] = bmcip
        out_json['mac'] = node.get_mac()
        header = ['Parameter', 'Value']
        content = []
        content.append(['name', curent_node_name])
        out_str = ''
        for key in sorted(out_json):
            content.append([key, out_json[key]])
        print_table(header, content)

def node_add(name, group):
    if name:
        for nodename in hostlist.expand_hostlist(name):
            node = luna.Node(name=nodename, group=group, create=True)
    else:
        node = luna.Node(name=name, group=group, create=True)

def node_change(**args):
    for nodename in hostlist.expand_hostlist(args['name']):
        node = luna.Node(nodename)

        for attr in ['group', 'mac', 'switch']:
            if args[attr] is not None:
                getattr(node, "set_%s" % attr)(args[attr])

        for attr in ['localboot', 'setupbmc', 'service']:
            if args[attr] is not None:
                flag = True if args[attr] in ['y', 'yes'] else False
                node.set(attr, flag)

        if args['interface']:
            node.set_ip(args['interface'][0], ip=args['interface'][1])

        if args['bmcip']:
            node.set_ip(ip=args['bmcip'], bmc=True)

        if args['port']:
            node.set('port', args['port'])

def node_delete(name):
    for nodename in hostlist.expand_hostlist(name):
        node = luna.Node(nodename)
        node.delete()

def node_rename(**args):
    node = luna.Node(args['name'])
    node.rename(args['newname'])

#################### Switch

def switch_list():
    switches = luna.list('switch')
    header =  ['Name', 'IP']
    content = []
    for elem in switches:
        switch = luna.Switch(elem)
        content.append([elem, switch.get('ip')])
    print_table(header, content)

def switch_show(name, raw, out_format = def_format):
    for switchname in hostlist.expand_hostlist(name):
        switch = luna.Switch(name = switchname)
        if raw:
            print(switch.nice_json)
            return None
        out_json = switch.show()
        out_json['ip'] = switch.get('ip')
        header = ['Parameter', 'Value']
        content = []
        content.append(['name', out_json.pop('name')])
        for key in sorted(out_json):
            content.append([key, out_json[key]])
        print_table(header, content)

def switch_add(**args):
    name = args.pop('name')
    args['create'] = True
    for switchname in hostlist.expand_hostlist(name):
        args['name'] = switchname
        switch = luna.Switch(**args)

def switch_change(**args):
    for switchname in hostlist.expand_hostlist(args['name']):
        switch = luna.Switch(switchname)
        args.pop('name')
        for key in args:
            if not args[key]:
                continue
            switch.set(key, args[key])

def switch_delete(name):
    for switchname in hostlist.expand_hostlist(name):
        switch = luna.Switch(switchname)
        switch.delete()

def switch_rename(**args):
    sw = luna.Switch(args['name'])
    sw.rename(args['newname'])

#################### Otherdev

def otherdev_list():
    devs = luna.list('otherdev')
    header = ['Name', 'IPs']
    content = []
    for elem in devs:
        dev = luna.OtherDev(elem)
        ips = []
        for net in dev.list_nets():
            ips.append("[" + net + "]:" + dev.get_ip(net))
        content.append([elem, ', '.join(ips)])
    print_table(header, content)

def otherdev_show(name, raw, out_format = def_format):
    for devname in hostlist.expand_hostlist(name):
        dev = luna.OtherDev(name = devname)
        if raw:
            print(dev.nice_json)
            return None
        ips = []
        for net in dev.list_nets():
            ips.append("[" + net + "]:" + dev.get_ip(net))
        out_json = dev.show()
        out_json['connected'] = ', '.join(ips)
        header = ['Parameter', 'Value']
        content = []
        content.append(['name', out_json.pop('name')])
        for key in sorted(out_json):
            content.append([key, out_json[key]])
        print_table(header, content)

def otherdev_add(**args):
    name = args.pop('name')
    args['create'] = True
    for otherdev in hostlist.expand_hostlist(name):
        args['name'] = otherdev
        dev = luna.OtherDev(**args)

def otherdev_change(**args):
    for devname in hostlist.expand_hostlist(args['name']):
        dev = luna.OtherDev(devname)
        args.pop('name')
        dev.set_ip(network = args['network'], ip = args['ip'])

def otherdev_delete(name):
    for devname in hostlist.expand_hostlist(name):
        dev = luna.OtherDev(devname)
        dev.delete()

def otherdev_rename(**args):
    otherdev = luna.OtherDev(args['name'])
    otherdev.rename(args['newname'])

parser = ArgumentParser(prog='luna',description='Manage Luna Cluster')
subparsers = parser.add_subparsers(help='Items to operate on', dest='item')

cluster_p = subparsers.add_parser('cluster', help='Basic cluster operations')
cluster_a = cluster_p.add_subparsers(dest='action')

osimage_p = subparsers.add_parser('osimage', help='OsImage operations')
osimage_a = osimage_p.add_subparsers(dest='action')

bmcsetup_p = subparsers.add_parser('bmcsetup', help='BMCSetup operations')
bmcsetup_a = bmcsetup_p.add_subparsers(dest='action')

network_p = subparsers.add_parser('network', help='Node operations.')
network_a = network_p.add_subparsers(dest='action')

group_p = subparsers.add_parser('group', help='Group operations')
group_a = group_p.add_subparsers(dest='action')

node_p = subparsers.add_parser('node', help='Node operations')
node_a = node_p.add_subparsers(dest='action')

switch_p = subparsers.add_parser('switch', help='Switch operations')
switch_a = switch_p.add_subparsers(dest='action')

otherdev_p = subparsers.add_parser('otherdev', help='Other devices operations')
otherdev_a = otherdev_p.add_subparsers(dest='action')

#
# Cluster commands
#

# show
cmd = cluster_a.add_parser('show',help='Show options')
cmd.add_argument('--raw', '-R', action='store_true', help='JSON output')

# init
cmd = cluster_a.add_parser('init', help='Create Luna Cluster')
cmd.add_argument('--nodeprefix', default='node', help='Prefix for new nodes')
cmd.add_argument('--nodedigits', type=int, default=3, help='Zero-autopadding')
cmd.add_argument('--user', default='luna', help='Username to run services as')
cmd.add_argument('--path', default='/opt/luna', help='Path to store files')

# change
cmd = cluster_a.add_parser('change', help='Change cluster options')
cmd.add_argument('--nodeprefix', '-p', help='Prefix for new nodes')
cmd.add_argument('--nodedigits', '-d', type=int, help='Zero-autopadding')
cmd.add_argument('--path', help='Path to store files')
cmd.add_argument('--user', help='Username for running services')
cmd.add_argument('--frontend_address', help='Server address')
cmd.add_argument('--frontend_port', type=int, help='Server address')
cmd.add_argument('--server_port', type=int, help='Server port')
cmd.add_argument('--tracker_interval', type=int,
                 help='Torrent tracker announce interval')
cmd.add_argument('--tracker_min_interval', type=int,
                 help='Torrent tracker announce min interval')
cmd.add_argument('--tracker_maxpeers', type=int,
                 help='Torrent tracker max allowed peers')
cmd.add_argument('--torrent_listen_port_min', type=int,
                 help='Torrent client listening port min')
cmd.add_argument('--torrent_listen_port_max', type=int,
                 help='Torrent client listening port max')
cmd.add_argument('--torrent_pidfile', help='Torrent pidfile')
cmd.add_argument('--lweb_num_proc', type=int,
                 help='Lweb number of processes. (0 for autodetection.)')
cmd.add_argument('--lweb_pidfile', type=int, help='Lweb pidfile')
cmd.add_argument('--cluster_ips', metavar='A.A.A.A,B.B.B.B',
                 help='IPs of the interfaces dedicated to provisioninig')
cmd.add_argument('--named_include_file', help='Include file for named.conf')
cmd.add_argument('--named_zone_dir', help='Dir where to store bind zone files')
#cmd.add_argument('--tracker_address', help='Torrent tracker address')
#cmd.add_argument('--tracker_port', type=int, help='Torrent tracker port')
#cmd.add_argument('--tracker_clean', action='store_true',
#                 help='Clean database from outdated records')

# sync
cmd = cluster_a.add_parser('sync', help='Synchronize cluster arcoss nodes')

# makedns
cmd = cluster_a.add_parser('makedns', help='Configure named')

# makedhcp
cmd = cluster_a.add_parser('makedhcp', help='Configure dhcpd')
cmd.add_argument('--no_ha', action='store_true', help='Create high availa')
cmd.add_argument('--network', '-N', required=True, help='Network name')
cmd.add_argument('--start_ip', '-s', required=True,
                 help='First ip in dynamic range')
cmd.add_argument('--end_ip', '-e', required=True,
                 help='Last ip in dynamic range')
# delete
cmd = cluster_a.add_parser('delete', help='Delete Luna Cluster')

#
# OsImage commands
#

# list
cmd = osimage_a.add_parser('list', help='List OSImages')

# show
cmd = osimage_a.add_parser('show', help='Show OSImage')
cmd.add_argument('name', help='Name of the OsImage')
cmd_group = cmd.add_mutually_exclusive_group()
cmd_group.add_argument('--raw', '-R', action='store_true', help='JSON output')
cmd_group.add_argument('--path', '-p', action='store_true',
                       help='Show path to OsImage')
cmd_group.add_argument('--kernver', '-k', action='store_true',
                       help='Show kernel versions')
cmd_group.add_argument('--kernopts', '-o', action='store_true',
                       help='Show kernel options.')
cmd_group.add_argument('--grab_exclude_list', '-e', action='store_true',
                       help='Show exclude list for grabbing host')
cmd_group.add_argument('--grab_filesystems', '-f', action='store_true',
                       help='Show filesystems to grab from host')

# listkerns
#cmd = osimage_a.add_parser('listkerns',
#                           help='List installed kernels in OsImage')
#cmd.add_argument('name', help='Name of the OsImage')

# add
cmd = osimage_a.add_parser('add', help='Add osimage')
cmd.add_argument('--name', '-n', required=True, help='Name of the OsImage')
cmd.add_argument('--path', '-p', required=True, help='Path to OsImage')
cmd.add_argument('--kernver', '-k', help='Kernel version. Can be "ANY" keyword (will be used when parameter is ommited)')
cmd.add_argument('--kernopts', '-o', help='Kernel options')

# change
cmd = osimage_a.add_parser('change', help='Change OsImage')
cmd.add_argument('name', help='Name of the OsImage')
cmd_group = cmd.add_mutually_exclusive_group()
cmd_group.add_argument('--kernver', '-k', help='Kernel version')
cmd_group.add_argument('--kernopts', '-o', help='Kernel options')
cmd_group.add_argument('--dracutmodules', '-d', help='Dracut modules')
cmd_group.add_argument('--kernmodules', '-m', help='Kernel modules (drivers)')
cmd_group.add_argument('--path', '-p', help='Path to osimage (EXPERIMENTAL)')
cmd_group.add_argument('--grab_exclude_list', '-e', action='store_true',
                       help='Change exclude list for grabbing host')
cmd_group.add_argument('--grab_filesystems', '-f',
                       help='Comma-separated filesystems to grab from host')

# pack
cmd = osimage_a.add_parser('pack', help='Pack OsImage')
cmd.add_argument('name', help='Name of the OsImage')
cmd_group = cmd.add_mutually_exclusive_group(required=False)
cmd_group.add_argument('--image', '-i', action='store_true',
                       help='Pack image only')
cmd_group.add_argument('--boot', '-b', action='store_true',
                       help='Pack kernel and initrd only')
cmd.add_argument('--copy_boot', '-c', action='store_true',
                 help='Copy kernel and initrd from image, not to run dracut')

# grab
cmd = osimage_a.add_parser('grab', help='Grab host to OsImage')
cmd.add_argument('name', help='Name of the OsImage')
cmd.add_argument('--host', '-H', required=True,
                 help='Hostname of the source node')
cmd.add_argument('--dry_run', '-d', action='store_true',
                 help='Do not change osimage. Report only')
cmd.add_argument('--verbose', '-v', action='store_true',
                 help='Print rsync output')

# sync
cmd = osimage_a.add_parser('sync', help='Sync OsImage')
cmd.add_argument('name', help='Name of the OsImage')

# clone
cmd = osimage_a.add_parser('clone', help='Clone OsImage')
cmd.add_argument('name', help='Name of image to clone')
cmd.add_argument('--to', '-t', required=True, help='Name of the clone image')
cmd.add_argument('--path', '-p', required=True,
                 help='Path of the Osimage to create.')

# rename
cmd = osimage_a.add_parser('rename', help='Rename OsImage')
cmd.add_argument('name', help='Name of the OsImage')
cmd.add_argument('--newname', '--nn', required=True, help='New name')

# delete
cmd = osimage_a.add_parser('delete', help='Delete OsImage')
cmd.add_argument('name', help='Name of the OsImage')

#
# BMCSetup commands
#

# list
cmd = bmcsetup_a.add_parser('list', help='List BMCSetup instances.')

# show
cmd = bmcsetup_a.add_parser('show', help='Show BMCSetup instance.')
cmd.add_argument('name', help='Name of the BMCSetup')
cmd.add_argument('--raw', '-R', action='store_true', help='Raw JSON output')

# add
cmd = bmcsetup_a.add_parser('add', help='Add BMCSetup instance')
cmd.add_argument('--name', '-n', required=True, help='Name of the BMCSetup')
cmd.add_argument('--user', '-u', default='ladmin', help='User name')
cmd.add_argument('--password', '-p', default='ladmin', help='Password')
cmd.add_argument('--userid', '-I', default=3, type=int, help='UserID')
cmd.add_argument('--netchannel', '-N', default=1, type=int, help='Netchannel')
cmd.add_argument('--mgmtchannel', '-M', default=1, type=int,
                 help='Mgmtchannel')

# change
cmd = bmcsetup_a.add_parser('change', help='Change BMCSetup')
cmd.add_argument('name', help='Name of the BMCSetup')
cmd.add_argument('--user', '-u', help='User name')
cmd.add_argument('--password', '-p', help='Password')
cmd.add_argument('--userid', '-I', type=int, help='UserID')
cmd.add_argument('--netchannel', '-N', type=int, help='Netchannel')
cmd.add_argument('--mgmtchannel', '-M', type=int, help='Mgmtchannel')

# rename
cmd = bmcsetup_a.add_parser('rename', help='Rename BMCSetup instance')
cmd.add_argument('name', help='Name of the BMCSetup')
cmd.add_argument('--newname', '--nn', required=True,
                 help='New name of the BMCSetup')

# delete
cmd = bmcsetup_a.add_parser('delete', help='Delete osimage')
cmd.add_argument('name', help='Name of the BMCSetup')

#
# Network commands
#

# list
cmd = network_a.add_parser('list', help='List Networks')

# show
cmd = network_a.add_parser('show', help='Show Network')
cmd.add_argument('name', help='Name of the Network')
cmd.add_argument('--raw', '-R', action='store_true', help='Raw JSON output')
cmd.add_argument('--reservedips', '-r', action='store_true',
                 help='List reserved IPs')
# add
cmd = network_a.add_parser('add', help='Add Network')
cmd.add_argument('--name', '-n', required=True, help='Name of the Network')
cmd.add_argument('--network', '-N', metavar='N.N.N.N', required=True,
                 help='Network')
cmd.add_argument('--prefix', '-P', metavar='PP', required=True, type=int,
                 help='Prefix')
cmd.add_argument('--ns_hostname', help='Name server for zone file')
cmd.add_argument('--ns_ip', metavar='N.N.N.N',
                 help='Name server\'s IP for zone file')
# change
cmd = network_a.add_parser('change', help='Change Network')
cmd.add_argument('name', help='Name of the Network')
cmd.add_argument('--network', '-N', metavar='N.N.N.N', help='Network')
cmd.add_argument('--prefix', '-P', metavar='PP', type=int, help='Prefix')
cmd.add_argument('--reserve', '-R', metavar='X.X.X.X', help='Reserve IP')
cmd.add_argument('--release', metavar='X.X.X.X', help='Release IP')
cmd.add_argument('--ns_hostname', help='Name server for zone file')
cmd.add_argument('--ns_ip', metavar='N.N.N.N',
                 help='Name server\'s IP for zone file')
# rename
cmd = network_a.add_parser('rename', help='Rename Network')
cmd.add_argument('name', help='Name of the Network')
cmd.add_argument('--newname', '--nn', required=True,
                 help='New name of the Network')
# delete
cmd = network_a.add_parser('delete', help='Delete Network')
cmd.add_argument('name', help='Name of the Network')

#
# Group commands
#

# list
cmd = group_a.add_parser('list', help='List Groups')

# show
cmd = group_a.add_parser('show', help='Show Group')
cmd.add_argument('name', help='Name of the Group')
cmd_group = cmd.add_mutually_exclusive_group()
cmd_group.add_argument('--raw', '-R', action='store_true', help='JSON output')
cmd_group.add_argument('--osimage', '-o', action='store_true',
                       help='Osimage assigned to Group.')
cmd_group.add_argument('--prescript', '--pre', action='store_true',
                       help='Set prescript')
cmd_group.add_argument('--postscript', '--post', action='store_true',
                       help='Set postscript.')
cmd_group.add_argument('--partscript', '--part', action='store_true', help='Set partition script. Localdisk should be mounted under /sysimage')
cmd_group.add_argument('--bmcsetup', '-b', action='store_true',
                       help='BMCSetup assigned to Group.')
cmd_group.add_argument('--interface', '-i', help='Interface')
cmd_group.add_argument('--bmcnetwork', '--bn', action='store_true',
                       help='Network for BMC')

# add
cmd = group_a.add_parser('add', help='Add Group')
cmd.add_argument('--name', '-n', required=True, help='Name of the Group')
cmd.add_argument('--osimage', '-o', required=True,
                 help='Osimage assigned to Group')
cmd.add_argument('--bmcsetup', '-b', help='BMCSetup assigned to Group')
cmd.add_argument('--bmcnetwork', '--bn', help='Network for BMC')
cmd.add_argument('--interface', '-i', action='append', required=True,
                 help='Interfaces specified in format -i eth0 -i eth1')

# change
cmd = group_a.add_parser('change', help='Change Group')
cmd.add_argument('name', help='Name of the Group')
cmd.add_argument('--osimage', '-o', help='Osimage assigned to Group')
cmd.add_argument('--prescript', '--pre', action='store_true',
                 help='Set prescript')
cmd.add_argument('--postscript', '--post', action='store_true',
                 help='Set postscript.')
cmd.add_argument('--partscript', '--part', action='store_true', help='Set partition script. Localdisk should be mounted under /sysimage')
cmd.add_argument('--bmcsetup', '-b', help='BMCSetup assigned to Group')
cmd.add_argument('--boot_if', '--bi', help='Boot interface')
cmd.add_argument('--torrent_if', '--ti', help='High-speed interface')
cmd_group = cmd.add_mutually_exclusive_group()
cmd_group.add_argument('--interface', '-i', help='Interface')
cmd_group.add_argument('--bmcnetwork', '--bn', action='store_true',
                       help='Network for BMC.')

cmd.add_argument('--add', '-A', action='store_true',
                 help='Add interface')
cmd.add_argument('--delete', '-D', action='store_true',
                 help='Delete interface')
cmd.add_argument('--setnet', '--sn', metavar='NETWORK',
                 help='Set Network for interface or for BMC')
cmd.add_argument('--delnet', '--dn', action='store_true',
                 help='Delete Network for interface or for BMC')
cmd.add_argument('--edit', '-e', action='store_true',
                 help='Edit interface parameters or edit scripts')

# rename
cmd = group_a.add_parser('rename', help='Rename Group.')
cmd.add_argument('name', help='Name of the Group')
cmd.add_argument('--newname', '--nn', required=True, help='New name')

# delete
cmd = group_a.add_parser('delete', help='Delete Group')
cmd.add_argument('name', help='Name of the Group')

#
# Node commands
#

# list
cmd = node_a.add_parser('list', help='List Nodes')

# show
cmd = node_a.add_parser('show', help='Show Node')
cmd.add_argument('name', help='Name of the Node')
cmd.add_argument('--raw', '-R', action='store_true', help='Raw JSON output')

# add
cmd = node_a.add_parser('add', help='Add Node')
cmd.add_argument('--name', '-n', help='Name of the Node')
cmd.add_argument('--group', '-g', required=True, help='Group')

# change
cmd = node_a.add_parser('change', help='Change Node')
cmd.add_argument('name', help='Name of the Node')
cmd_group = cmd.add_mutually_exclusive_group(required=False)
cmd_group.add_argument('--group', '-g', help='Group')
cmd_group.add_argument('--interface', '-i', nargs=2, metavar=('IF', 'X.X.X.X'),
                       help='Assign ip address to interface')
cmd_group.add_argument('--bmcip', '-b', metavar='X.X.X.X',
                       help='Assign ip address to BMC interface')
cmd.add_argument('--mac', metavar='XX:XX:XX:XX:XX',
                 help='Mac address. Specify empty string to erase')
cmd.add_argument('--switch', '-s', help='Switch')
cmd.add_argument('--port', '-p', help='Switch port')
cmd.add_argument('--localboot', '-l', choices=['y', 'yes', 'n', 'no'],
                 help='Boot from local HDD')
cmd.add_argument('--setupbmc', '--sb', choices=['y', 'yes', 'n', 'no'],
                 help='Whether to setup BMC on install')
cmd.add_argument('--service', '--sv', choices=['y', 'yes', 'n', 'no'],
                 help='Enter to service mode instead of install')

# rename
cmd = node_a.add_parser('rename', help='Rename Node')
cmd.add_argument('name', help='Name of the Node')
cmd.add_argument('--newname', '--nn', required=True, help='New name')

# delete
cmd = node_a.add_parser('delete', help='Delete Node')
cmd.add_argument('name', help='Name of the Node')

#
# Switch commands
#

# list
cmd = switch_a.add_parser('list', help='List Switches')

# show
cmd = switch_a.add_parser('show', help='Show Switch')
cmd.add_argument('name', help='Name of the Switch')
cmd.add_argument('--raw', '-R', action='store_true', help='Raw JSON output')

# add
cmd = switch_a.add_parser('add', help='Add Switch')
cmd.add_argument('--name', '-n', required=True, help='Name of the Switch')
cmd.add_argument('--network', '-N', required=True,
                 help='Network Switch belongs to')
cmd.add_argument('--ip', '-i', required=True, help='IP of the Switch')
cmd.add_argument('--read', '-r', default='public', help='Read community')
cmd.add_argument('--rw', '-w', default='private', help='Write community')
cmd.add_argument('--oid', '-o', default = '.1.3.6.1.2.1.17.7.1.2.2.1.2',
                 help='OID of the Switch')

# change
cmd = switch_a.add_parser('change', help='Change Switch')
cmd.add_argument('name', help='Name of the Switch')
cmd.add_argument('--network', '-N', help='Network Switch belongs to')
cmd.add_argument('--ip', '-i', help='IP of the Switch')
cmd.add_argument('--read', '-r', help='Read community')
cmd.add_argument('--rw', '-w', help='Write community')
cmd.add_argument('--oid', '-o', help='OID of the Switch')

# rename
cmd = switch_a.add_parser('rename', help='Rename Switch')
cmd.add_argument('name', help='Name of the Switch')
cmd.add_argument('--newname', '--nn', required=True, help='New name')

# delete
cmd = switch_a.add_parser('delete', help='Delete Switch')
cmd.add_argument('name', help='Name of the Switch')

#
# Otherdev commands
#

# list
cmd = otherdev_a.add_parser('list', help='List other devices')

# show
cmd = otherdev_a.add_parser('show', help='Show device')
cmd.add_argument('name', help='Name of the device')
cmd.add_argument('--raw', '-R', action='store_true', help='Raw JSON output')

# add
cmd = otherdev_a.add_parser('add', help='Add device')
cmd.add_argument('--name', '-n', required=True, help='Name of the device')
cmd.add_argument('--network', '-N', required=True,
                 help='Network device belongs to')
cmd.add_argument('--ip', '-i', help='IP of the device')

# change
cmd = otherdev_a.add_parser('change', help='Change device')
cmd.add_argument('name', help='Name of the device')
cmd.add_argument('--network', '-N', help='Network device belongs to')
cmd.add_argument('--ip', '-i',
                 help='IP of the device. Specify empty string to delete')

# rename
cmd = otherdev_a.add_parser('rename', help='Rename device')
cmd.add_argument('name', help='Name of the device')
cmd.add_argument('--newname', '--nn', required=True, help='New name')

# delete
cmd = otherdev_a.add_parser('delete', help='Delete device')
cmd.add_argument('name', help='Name of the device')


if __name__ == '__main__':
        args = vars(parser.parse_args())

        try:
            if args['action'] in ['add', 'change', 'rename', 'delete']:
                check_active_node()

            call_fun = globals()['%s_%s' % (args['item'], args['action'])]
            args.pop('item')
            args.pop('action')

            call_fun(**args)

        except RuntimeError:
           exit(255)
        except:
            raise
